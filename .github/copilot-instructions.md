# Copilot Instructions

- Goal: Home Assistant add-on receives Bresser/AWEKAS weather station GET updates and writes them to InfluxDB; main flow in [awekas-receiver/src/index.ts](awekas-receiver/src/index.ts) wires env load → Influx init/validate → Express → signal handlers.
- HTTP API: Express 5 server started in [services/http/init.http.services.ts](awekas-receiver/src/services/http/init.http.services.ts) with JSON body parsing, rate limiting, and Awekas router mounted. Routes in [models/awekas/routers/index.ts](awekas-receiver/src/models/awekas/routers/index.ts): `GET /` returns a simple banner; `GET /weatherstation/updateweatherstation.php` handles uploads.
- Request validation: `updateData` handler in [models/awekas/routers/update.router.awekas.ts](awekas-receiver/src/models/awekas/routers/update.router.awekas.ts) runs `validateRequest` to enforce Awekas params (ID/PASSWORD/action=updateraww/realtime=1/dateutc=now) and logs+400/401 before processing.
- Auth scheme: only users listed in ENABLED_USERS (comma-separated) are accepted and password must equal SHA-256 of `${user}${HASH_SALT}` (`generateAuth` in [services/auth/generate.auth.services.ts](awekas-receiver/src/services/auth/generate.auth.services.ts), `validateUserPassword` in [services/auth/validate-user-password.auth.services.ts](awekas-receiver/src/services/auth/validate-user-password.auth.services.ts)).
- Data mapping: query params convert to number then normalized to SI units in [models/awekas/domain/map-request-to-model.domain.awekas.ts](awekas-receiver/src/models/awekas/domain/map-request-to-model.domain.awekas.ts) and [convert-si.domain.awekas.ts](awekas-receiver/src/models/awekas/domain/convert-si.domain.awekas.ts) (°F→°C, inHg→hPa, mph→km/h, in→mm).
- Storage: `addMeasurement` in [models/awekas/handlers/add-measurement.handlers.awekas.ts](awekas-receiver/src/models/awekas/handlers/add-measurement.handlers.awekas.ts) calls Influx service `addMeasure` to map each field to an Influx `Point` with measurement name = field key, tag `station` = sensor ID, field `value` = number ([services/influx/map-awekas-to-point.influx.services.ts](awekas-receiver/src/services/influx/map-awekas-to-point.influx.services.ts)). Influx connection is initialized/validated on startup and closed per write in [services/influx/connect.influx.services.ts](awekas-receiver/src/services/influx/connect.influx.services.ts) + [add-measure.influx.services.ts](awekas-receiver/src/services/influx/add-measure.influx.services.ts).
- Environment/config: `.env` is loaded via `configureEnv`; read values with `getEnvVar` and defaults from [services/environment/model.environment.services.ts](awekas-receiver/src/services/environment/model.environment.services.ts) (PORT=3000, INFLUX defaults, rate limits, HASH_SALT=awekas, ENABLED_USERS=TORRE01). Add-on runtime exports same vars from [awekas-receiver/run.sh](awekas-receiver/run.sh); update both if adding new config.
- Rate limiting: middleware factory in [services/http/middlewares/rate-limit.middleware.http.services.ts](awekas-receiver/src/services/http/middlewares/rate-limit.middleware.http.services.ts) uses `express-slow-down`; defaults derive from env (window minutes, max requests, per-request delay seconds). All HTTP traffic goes through it in `initHTTP`.
- Logging: thin wrappers in [services/log/*.ts](awekas-receiver/src/services/log) prefix INFO/WARN/ERROR with lowercase date string; use `Services.Log` instead of `console.*` for consistency.
- Shutdown: signal hooks in [services/signal](awekas-receiver/src/services/signal) close the HTTP server and process. The entrypoint also closes Influx explicitly during fatal start failures.
- Data model: Awekas query/model types in [models/awekas/awekas.model.ts](awekas-receiver/src/models/awekas/awekas.model.ts); keep new fields mirrored across query parsing, SI conversion, and Influx mapping.
- Tests: Jest unit tests for domain logic live beside implementations (e.g., [convert-si.domain.awekas.spec.ts](awekas-receiver/src/models/awekas/domain/convert-si.domain.awekas.spec.ts), [validate-request.domain.awekas.spec.ts](awekas-receiver/src/models/awekas/domain/validate-request.domain.awekas.spec.ts)). Mirror this pattern for new domain utilities; tests are TS run via Babel/Jest.
- Dev commands (run from awekas-receiver/): `npm install`; `npm start` (nodemon + ts-node); `npm run build` (tsc to dist, cleans first); `npm run lint` / `lint:fix`; `npm test`. Add-on container build uses [awekas-receiver/Dockerfile](awekas-receiver/Dockerfile) and metadata in [config.yaml](awekas-receiver/config.yaml), with service launch via s6 in [run.sh](awekas-receiver/run.sh).
- Patterns to follow: import services via the `Services` barrel ([src/services/index.ts](awekas-receiver/src/services/index.ts)) to keep dependency graph flat; use env accessors instead of `process.env` directly; keep request validation/authentication ahead of Influx writes; prefer SI units internally and only adjust in domain converters.
- When extending API: add routes under [models/awekas/routers](awekas-receiver/src/models/awekas/routers), validate query/body, convert to model, reuse rate limiter, and log client IP + query for failures as `updateData` does.
- Troubleshooting: startup failures log banner and exit non-zero if Influx validation fails; verify INFLUX_* env and bucket existence. Rate-limit settings can block noisy stations—tune via env.
